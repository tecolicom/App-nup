#!/usr/bin/env bash
# vim: filetype=bash :  -*- mode: sh; sh-shell: bash; -*-

set -euo pipefail

define() { IFS='\n' read -r -d '' ${1} || true ; }

myname="${0##*/}"

define pod <<"=cut"

=encoding utf-8

=head1 NAME

nup - N-up output wrapper for optex -Mup

=head1 SYNOPSIS

nup [ options ] command ...

    -h, --help         show help
        --version      show version
    -d, --debug        debug mode
    -n, --dryrun       dry-run mode

=head1 VERSION

Version 0.01

=cut

[[ $pod =~ Version\ +([0-9.]+) ]] && my_version=${BASH_REMATCH[1]}

# -h callback: show help from POD
help() {
    sed -E \
        -e '/^$/N' \
        -e 's/^(\n*)=head[0-9]* */\1/' \
        -e '/^\n*[#=]/d' \
        -e '/Version/q' \
        <<< "$pod"
    exit 0
}

# -v callback: show version
version() {
    echo "$my_version"
    exit 0
}

##############################################################################
# Utility functions
##############################################################################

debug() {
    [[ ${debug:-} ]] && echo "debug: $*" >&2 || true
}

die() {
    echo "$myname: $*" >&2
    exit 1
}

# Check bash version (4.3+ required for getoptlong.sh)
if ((BASH_VERSINFO[0] < 4 || (BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] < 3))); then
    die "bash 4.3+ required (found $BASH_VERSION)"
fi

##############################################################################
# Setup PATH for getoptlong.sh
##############################################################################

dist_dir() {
    perl -MFile::Share=:all -E "say dist_dir '$1'" 2>/dev/null || true
}
share=$(dist_dir App-nup)
PATH="${share:+$share/getoptlong:}$PATH"
command -v getoptlong.sh > /dev/null || {
    basedir="${0%/*/*}"
    [[ -f $basedir/share/getoptlong/getoptlong.sh ]] &&
        PATH="$basedir/share/getoptlong:$PATH"
}

##############################################################################
# Option definitions
##############################################################################

define USAGE <<END
nup - N-up output wrapper for optex -Mup

Usage: $myname [ options ] command ...
END

declare -A OPTS=(
    [&USAGE]="$USAGE" [&PERMUTE]= [&REQUIRE]=0.2
    [   help | h ! # show help    ]=
    [version |   ! # show version ]=
    [  debug | d   # debug mode   ]=
    [ dryrun | n   # dry-run mode ]=
)

##############################################################################
# Parse options
##############################################################################

. getoptlong.sh OPTS "$@"

##############################################################################
# Main
##############################################################################

declare -a cmd=(optex -Mup "$@")

debug "command: ${cmd[*]}"

if [[ ${dryrun:-} ]]; then
    echo "${cmd[@]}"
    exit 0
fi

exec "${cmd[@]}"

: <<'=cut'

=head1 DESCRIPTION

B<nup> is a simple wrapper script for C<optex -Mup>.  It provides a
convenient way to run commands with N-up output formatting using the
L<App::optex::up> module.

=head1 INSTALLATION

Using L<cpanminus|https://metacpan.org/pod/App::cpanminus>:

    cpanm -n App::nup

=head1 SEE ALSO

L<App::optex::up>, L<optex>

=head1 AUTHOR

Kazumasa Utashiro

=head1 LICENSE

Copyright 2025 Kazumasa Utashiro.

This software is released under the MIT License.
L<https://opensource.org/licenses/MIT>

=cut
